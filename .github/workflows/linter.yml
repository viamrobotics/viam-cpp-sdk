name: cpp-linter

on: pull_request

jobs:
  cpp-linter:
    if: github.repository_owner == 'viamrobotics'
    runs-on: [self-hosted, x64]
    container:
      image: ghcr.io/viamrobotics/canon:amd64
    steps:
      - name: Checkout PR/Push/Workflow Dispatch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: install clang-format
        run: sudo apt install -y clang-format
      - name: Run linter
        run: sh ./bin/run-clang-format.sh
      - name: check for uncommitted changes
        id: changes
        uses: UnicornGlobal/has-changes-action@v1.0.11
      - name: process changes
        if: steps.changes.outputs.changed == 1
        run: echo "Linter failed with uncommitted changes" && return 1
